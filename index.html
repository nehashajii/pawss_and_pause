<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Neon Cat: Smart Drone Edition</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap');

        body {
            margin: 0;
            background-color: #050505;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            color: white;
            font-family: 'Press Start 2P', monospace;
            overflow: hidden;
            user-select: none;
            touch-action: none;
        }

        #game-container {
            position: relative;
            width: 800px;
            height: 450px;
            box-shadow: 0 0 30px #00ffff;
            border: 4px solid #333;
            background: #111;
        }

        canvas { display: block; width: 100%; height: 100%; }

        #ui-layer {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            pointer-events: none;
            padding: 20px;
            display: flex;
            justify-content: space-between;
        }

        .hud-text { font-size: 16px; color: #fff; text-shadow: 2px 2px #000; }
        .highlight { color: #0ff; }

        /* Screens */
        #start-screen, #game-over, #level-complete {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.92);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 20;
            pointer-events: auto;
            text-align: center;
        }

        h1 { color: #0ff; margin-bottom: 20px; line-height: 1.5; font-size: 24px; }
        p { color: #aaa; font-size: 12px; margin-bottom: 30px; line-height: 2.0; max-width: 500px; }
        
        button {
            background: #ff00ff; color: white; border: 4px solid #fff;
            padding: 20px 40px; font-family: inherit; font-size: 16px;
            cursor: pointer; text-transform: uppercase;
            box-shadow: 0 0 15px #ff00ff; margin-top: 20px;
        }
        button:hover { background: #fff; color: #ff00ff; }

        .hidden { display: none !important; }
        .warning { color: #ff4444; }

    </style>
</head>
<body>

    <div id="game-container">
        
        <div id="ui-layer">
            <div class="hud-text">LEVEL <span id="level-txt" class="highlight">1</span></div>
            <div class="hud-text">GOAL <span id="dist-txt" class="highlight">0%</span></div>
        </div>

        <div id="start-screen">
            <h1>NEON CAT<br>SMART DRONE</h1>
            <p>
                1. HOLD <span class="highlight">[CLICK/SPACE]</span> to Run.<br>
                2. RELEASE to Stop.<br>
                3. The Drone is <span class="warning">UNPREDICTABLE</span>.<br>
                It will wait, speed up, and stop randomly.
            </p>
            <button onclick="startGame()">START GAME</button>
        </div>

        <div id="game-over" class="hidden">
            <h1 class="warning">CAUGHT!</h1>
            <p>You moved while illuminated.</p>
            <button onclick="restartLevel()">RETRY LEVEL</button>
        </div>

        <div id="level-complete" class="hidden">
            <h1 class="highlight">SAFE!</h1>
            <p>Area Cleared.</p>
            <button onclick="nextLevel()">NEXT LEVEL</button>
        </div>

        <canvas id="gameCanvas" width="800" height="450"></canvas>
    </div>

    <script>
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        const uiStart = document.getElementById('start-screen');
        const uiGameOver = document.getElementById('game-over');
        const uiLevelComplete = document.getElementById('level-complete');

        // --- LEVEL CONFIGURATION ---
        const LEVELS = [
            { id: 1, length: 1200, boxes: 3, droneType: "EASY" },    // Slow, predictable
            { id: 2, length: 1500, boxes: 4, droneType: "STOPGO" },  // Stops and waits
            { id: 3, length: 1800, boxes: 3, droneType: "FAST" },    // Moves fast
            { id: 4, length: 2000, boxes: 5, droneType: "ERRATIC" }, // Random speed + stops
            { id: 5, length: 3000, boxes: 6, droneType: "CHAOS" }    // Everything combined
        ];

        // --- GAME VARIABLES ---
        let state = "MENU"; 
        let currentLevelIdx = 0;
        let frame = 0;
        let camX = 0;
        let isHolding = false;

        // Entities
        let player = { x: 50, y: 340, w: 30, h: 20, vx: 0, hidden: false };
        let drone = { 
            x: 400, y: 50, 
            width: 140, 
            targetX: 400, 
            state: "IDLE", 
            timer: 0,
            speed: 0.05 
        };
        let boxes = [];
        let stars = [];

        // --- INIT ---
        function initStars() {
            stars = [];
            for(let i=0; i<80; i++) {
                stars.push({x: Math.random()*800, y: Math.random()*300, s: Math.random()*2});
            }
        }

        function startGame() {
            currentLevelIdx = 0;
            loadLevel();
        }

        function nextLevel() {
            currentLevelIdx++;
            if(currentLevelIdx >= LEVELS.length) currentLevelIdx = 0; // Loop back or end
            loadLevel();
        }

        function restartLevel() {
            loadLevel();
        }

        function loadLevel() {
            let config = LEVELS[currentLevelIdx];
            
            // Reset UI
            uiStart.classList.add('hidden');
            uiGameOver.classList.add('hidden');
            uiLevelComplete.classList.add('hidden');
            document.getElementById('level-txt').innerText = config.id;

            // Reset Player
            player.x = 50; player.vx = 0; player.hidden = false;
            camX = 0;

            // Reset Drone
            drone.x = 400; 
            drone.targetX = 400;
            drone.state = "PICK_TARGET";
            drone.timer = 0;

            // Generate Boxes
            boxes = [];
            for(let i=0; i<config.boxes; i++) {
                boxes.push({
                    x: 300 + Math.random() * (config.length - 400),
                    y: 335, w: 50, h: 30
                });
            }

            // Init Stars
            initStars();

            state = "PLAYING";
            requestAnimationFrame(loop);
        }

        // --- DRONE AI SYSTEM ---
        function updateDrone() {
            let config = LEVELS[currentLevelIdx];
            let type = config.droneType;

            // Current visible area center (where the player is roughly)
            let patrolCenter = camX + 400;

            // STATE MACHINE
            if (drone.state === "PICK_TARGET") {
                // Decide where to go next based on Level Type
                
                let range = 350; // How far from center can it go
                let nextX = patrolCenter + (Math.random() * range * 2 - range);
                
                // Clamp within map bounds
                if (nextX < 0) nextX = 0;
                if (nextX > config.length + 400) nextX = config.length + 400;

                drone.targetX = nextX;
                
                // Decide Speed
                if (type === "EASY") drone.speed = 0.03;
                else if (type === "FAST") drone.speed = 0.08;
                else if (type === "ERRATIC") drone.speed = Math.random() * 0.08 + 0.02; // Random speed
                else drone.speed = 0.05;

                drone.state = "MOVING";
            
            } else if (drone.state === "MOVING") {
                // Move towards target
                drone.x += (drone.targetX - drone.x) * drone.speed;

                // Check if arrived
                if (Math.abs(drone.x - drone.targetX) < 5) {
                    drone.state = "WAITING";
                    
                    // Decide wait time based on Level Type
                    if (type === "EASY") drone.timer = 0; // Don't stop
                    else if (type === "STOPGO") drone.timer = Math.random() * 100 + 50; // Long wait
                    else if (type === "ERRATIC") drone.timer = Math.random() * 60; // Random wait
                    else drone.timer = 20; // Short pause
                }

            } else if (drone.state === "WAITING") {
                drone.timer--;
                if (drone.timer <= 0) {
                    drone.state = "PICK_TARGET";
                }
            }
        }

        // --- MAIN UPDATE ---
        function update() {
            frame++;

            // 1. Player Physics
            if (isHolding) player.vx += 0.8;
            else player.vx *= 0.8;
            
            player.vx = Math.min(Math.max(player.vx, 0), 8);
            player.x += player.vx;

            // Camera
            let targetCam = player.x - 150;
            if (targetCam < 0) targetCam = 0;
            camX += (targetCam - camX) * 0.1;

            // 2. Box Hiding
            player.hidden = false;
            boxes.forEach(b => {
                if (Math.abs((player.x + 15) - (b.x + 25)) < 20) {
                    player.hidden = true;
                }
            });

            // 3. Drone Logic
            updateDrone();

            // 4. Detection Logic
            let dist = Math.abs((player.x + 15) - drone.x);
            let inLight = dist < (drone.width / 2);

            if (inLight && !player.hidden) {
                // Caught if moving
                if (Math.abs(player.vx) > 0.5) {
                    gameOver();
                }
            }

            // 5. Win Logic
            let lvlLen = LEVELS[currentLevelIdx].length;
            if (player.x > lvlLen) {
                state = "WIN";
                uiLevelComplete.classList.remove('hidden');
            }

            // UI
            let pct = Math.floor((player.x / lvlLen) * 100);
            document.getElementById('dist-txt').innerText = Math.min(100, pct) + "%";
        }

        function gameOver() {
            state = "GAMEOVER";
            uiGameOver.classList.remove('hidden');
        }

        // --- DRAWING ---
        function draw() {
            // Background
            ctx.fillStyle = "#050510";
            ctx.fillRect(0, 0, canvas.width, canvas.height);

            // Stars
            ctx.fillStyle = "#fff";
            stars.forEach(s => {
                let sx = (s.x - camX * 0.2) % 800;
                if(sx < 0) sx += 800;
                ctx.fillRect(sx, s.y, s.s, s.s);
            });

            ctx.save();
            ctx.translate(-camX, 0);

            // Floor
            let lvlLen = LEVELS[currentLevelIdx].length;
            ctx.fillStyle = "#222";
            ctx.fillRect(0, 360, lvlLen + 800, 90);
            ctx.strokeStyle = "#555";
            ctx.beginPath(); ctx.moveTo(0,360); ctx.lineTo(lvlLen+800, 360); ctx.stroke();

            // Boxes
            boxes.forEach(b => {
                ctx.fillStyle = "#cd853f"; ctx.fillRect(b.x, b.y, b.w, b.h);
                ctx.strokeStyle = "#8b4513"; ctx.lineWidth=2; ctx.strokeRect(b.x, b.y, b.w, b.h);
                ctx.fillStyle = "rgba(0,0,0,0.5)"; ctx.fillText("HIDE", b.x+10, b.y+20);
            });

            // Goal
            ctx.fillStyle = "#0f0"; ctx.fillRect(lvlLen, 280, 20, 80);
            ctx.fillText("EXIT", lvlLen-10, 270);

            // Player
            if (player.hidden) {
                let myBox = boxes.find(b => Math.abs((player.x+15)-(b.x+25)) < 30);
                if(myBox) {
                    ctx.fillStyle="#fff"; ctx.fillRect(myBox.x+15, myBox.y+10, 4, 4); ctx.fillRect(myBox.x+30, myBox.y+10, 4, 4);
                    ctx.fillStyle="#0f0"; ctx.font="10px monospace"; ctx.fillText("SAFE", myBox.x+12, myBox.y-10);
                }
            } else {
                ctx.fillStyle = "#0ff"; ctx.shadowBlur=15; ctx.shadowColor="#0ff";
                let bounce = Math.abs(Math.sin(frame * 0.5)) * (player.vx * 1.5);
                let stretch = player.vx * 3;
                ctx.fillRect(player.x, player.y+bounce, player.w+stretch, player.h-bounce/2);
                ctx.fillRect(player.x+player.w+stretch-5, player.y-10+bounce, 15, 15);
                ctx.shadowBlur=0;
            }

            ctx.restore();

            // Lighting
            drawLight();
        }

        function drawLight() {
            // Dark Overlay
            ctx.fillStyle = "rgba(0,0,0,0.85)";
            ctx.fillRect(0, 0, canvas.width, canvas.height);

            ctx.save();
            let dx = drone.x - camX;

            // Cutout
            ctx.globalCompositeOperation = "destination-out";
            ctx.beginPath();
            ctx.moveTo(dx, drone.y);
            ctx.lineTo(dx - drone.width/2, canvas.height);
            ctx.lineTo(dx + drone.width/2, canvas.height);
            ctx.fill();

            // Beam Color
            ctx.globalCompositeOperation = "source-over";
            let grad = ctx.createLinearGradient(0, drone.y, 0, 400);
            
            // Logic: Is Caught?
            let dist = Math.abs((player.x + 15) - drone.x);
            let inLight = dist < (drone.width/2);
            let caught = (inLight && !player.hidden && player.vx > 0.5);

            let col = caught ? "rgba(255, 0, 0, 0.6)" : "rgba(255, 255, 100, 0.2)";
            grad.addColorStop(0, "rgba(0,0,0,0)"); grad.addColorStop(1, col);
            ctx.fillStyle = grad;
            ctx.beginPath();
            ctx.moveTo(dx, drone.y);
            ctx.lineTo(dx - drone.width/2, canvas.height);
            ctx.lineTo(dx + drone.width/2, canvas.height);
            ctx.fill();

            // Drone Body
            ctx.fillStyle = "#333";
            ctx.fillRect(dx - 20, drone.y - 15, 40, 15);
            
            // Eye Color Logic
            // Yellow = Moving, Orange = Waiting, Red = Caught
            if (caught) ctx.fillStyle = "#f00";
            else if (drone.state === "WAITING") ctx.fillStyle = "#ff8800"; // Orange when suspicious/waiting
            else ctx.fillStyle = "#0ff"; // Blue when patrolling

            ctx.fillRect(dx - 5, drone.y - 5, 10, 5);
            ctx.restore();
        }

        function loop() {
            if (state === "PLAYING") {
                update();
                draw();
                requestAnimationFrame(loop);
            }
        }

        // --- INPUT ---
        function setInput(val) { isHolding = val; }
        window.addEventListener('mousedown', ()=>setInput(true));
        window.addEventListener('mouseup', ()=>setInput(false));
        window.addEventListener('touchstart', (e)=>{e.preventDefault(); setInput(true)}, {passive:false});
        window.addEventListener('touchend', (e)=>{e.preventDefault(); setInput(false)});
        window.addEventListener('keydown', (e)=>{if(e.code==='Space') setInput(true)});
        window.addEventListener('keyup', (e)=>{if(e.code==='Space') setInput(false)});

    </script>
</body>
</html>